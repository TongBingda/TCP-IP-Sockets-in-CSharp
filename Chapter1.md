# 一、引言
## 1.1 网络，数据包和协议

计算机网络由通过通信通道互连的机器组成。我们称这些机器为主机和路由器。主机是运行诸如Web浏览器之类的应用程序的计算机，在主机上运行的应用程序实际上是网络的用户。路由器的工作是将信息从一个通信通道中继或转发到另一个通信通道。它们可以运行程序，但通常不运行应用程序。就我们的目的而言，通信通道是一种将字节序列从一个主机传送到另一个主机的方法。它可能是一种广播技术，例如以太网，拨号调制解调器连接或其他更复杂的技术。

路由器之所以重要，仅是因为将每个主机直接连接到其他主机并不现实。相反，一些主机连接到路由器，然后再连接到其他路由器，依此类推以形成网络。这种安排使每台机器都可以使用相对较少的通信通道。但是，通过网络交换信息的程序不会直接与路由器进行交互，并且通常不知道它们的存在。

所谓信息，是指由程序构造和解释的字节序列。在计算机网络的上下文中，这些字节序列通常称为数据包。数据包包含网络用来完成其工作的控制信息，有时还包含用户数据。一个示例是有关数据包目的地的信息。路由器使用此类控制信息来确定如何转发每个数据包。

协议是关于通过通信程序交换的数据包及其含义的协议。协议告诉包的结构（例如，目的地信息在包中的位置以及包的大小）以及如何解释信息。协议通常设计为使用给定功能来解决特定问题。

实现网络连接需要解决大量不同的问题。为了使事情易于管理和模块化，设计了不同的协议来解决不同的问题。TCP/IP就是这样一种解决方案的集合，有时也称为协议套件。它恰好是Internet中使用的协议套件，但也可以在独立的专用网络中使用。之后，当我们说“网络”时，是指使用TCP/IP协议系列的任何网络。TCP/IP系列中的主要协议是Internet协议（IP），传输控制协议（TCP）和用户数据报协议（UDP）。

TCP/IP和几乎所有其他协议系列都是以多层的方式组织的。图1.1显示了主机和路由器中协议，应用程序和套接字API之间的关系，以及从一个应用程序（使用TCP）到另一个应用程序的数据流。标记为TCP，UDP和IP的框代表这些协议的实现。这样的实现通常驻留在主机的操作系统中。应用程序通过套接字API访问UDP和TCP提供的服务。箭头描绘了来自应用程序，通过TCP和IP实现，通过网络以及通过另一端的IP和TCP实现进行备份的数据流。



图1.1 一个TCP/IP网络

在TCP/IP中，底层由基础通信通道组成，例如以太网或拨号调制解调器连接。这些信道由网络层使用，处理了将分组转发到其目的地的问题（即，路由器做什么）。TCP/IP系列中的单个网络层协议是Internet协议；它解决了使任何两个主机之间的通道和路由器顺序看起来像单个主机到主机通道的问题。

互联网协议提供数据报服务：每个数据包均由网络独立处理和发送，例如通过邮政系统发送的电报或包裹。为了使此工作正常进行，每个IP数据包都必须包含其目的地的地址，就像邮寄的每个包裹都发送给某人一样。（我们稍后会详细讨论地址。）尽管大多数包裹递送公司都会保证包裹的递送，但IP只是一种尽力而为的协议：它尝试递送每个数据包，但它（有时确实）会丢失，重新订购，或通过网络传输的重复数据包。

IP之上的层称为传输层。它提供两种协议之间的选择：TCP和UDP。每个都基于IP提供的服务，但是它们以不同的方式提供不同种类的通道，供具有不同需求的应用协议使用。TCP和UDP有一个共同的功能：寻址。回想一下，IP将数据包传递到主机；显然，需要一种精细的寻址方式才能将数据包发送到特定的应用程序，也许是在同一主机中使用网络的许多应用程序之一。TCP和UDP都使用称为端口号的地址，以便可以识别主机中的应用程序。之所以称它们为端到端传输协议，是因为它们将数据从一个程序一直传送到另一个程序（而IP将数据从一个主机传送到另一个主机）。

TCP旨在检测IP中提供的主机到主机通道中可能发生的丢失，重复和其他错误，并从中恢复。TCP提供了可靠的字节流通道，因此应用程序不必处理这些问题。它是一种面向连接的协议：在使用它进行通信之前，两个程序必须首先建立一个TCP连接，这涉及到在两台通信计算机上的TCP实现之间完成握手消息的交换。使用TCP类似于文件输入/输出（I/O）。实际上，由一个程序编写并由另一个程序读取的文件是通过TCP连接进行通信的一种合理方式。另一方面，UDP不会尝试从IP遇到的错误中恢复；它只是扩展了IP尽力而为数据报服务，以便它在应用程序之间而不是主机之间工作。因此，必须准备使用UDP的应用程序来处理丢失，重新排序等问题。

## 1.2 关于地址

邮寄信件时，您以邮政服务可以理解的形式提供收件人的地址。您必须先将其号码提供给电话系统，然后才能与电话上的某人通话。以类似的方式，在程序可以与另一个程序进行通信之前，它必须告诉网络在哪里可以找到另一个程序。在TCP/IP中，需要两条信息来标识特定程序：IP使用的Internet地址和端口号（由传输协议（TCP或UDP）解释的附加地址）。

Internet地址是32位二进制数。写下供人类使用的Internet地址（而不是在应用程序内部使用它们），我们通常将其显示为由四个十进制数字组成的字符串，并用句点分隔（例如10.1.2.3）；这称为点分四进制表示法。点分四进制字符串中的四个数字表示Internet地址四个字节的内容，因此，每个数字都是0到255之间的数字。
从技术上讲，每个Internet地址都是指主机与基础通信通道（如拨号调制解调器或以太网卡）之间的连接。因为每个这样的网络连接都属于一个主机，所以Internet地址会标识一个主机及其与网络的连接。但是，由于一台主机可以具有到网络的多个物理连接（接口），所以一台主机可以具有多个Internet地址。

TCP或UDP中的端口号始终相对于Internet地址进行解释。回到我们以前的类比，端口号对应于给定街道地址（例如，大型建筑物的地址）上的房间号。邮政服务使用街道地址将信件发送到邮箱；清空邮箱的人将负责将信件送至建筑物内的适当房间。或考虑使用内部电话系统的公司：要与公司中的某个人讲话，您首先要拨打公司的主要电话号码以连接到内部电话系统，然后拨打您要讲话的人的特定电话的分机号。在这些类比中，Internet地址是街道地址或公司的主要号码，而端口对应于房间号或电话分机。端口号是16位无符号二进制数，因此每个数字都在1到65,535之间（保留0）。

## 1.3 关于名称

您很可能习惯了按名称引用主机（例如host.example.com）。但是，Internet协议处理数字地址，而不是名称。您应该理解，使用名称代替地址是一项便利功能，它独立于TCP/IP提供的基本服务，携带您无需编写名称就可以编写和使用TCP/IP应用程序。使用名称标识通信端点时，系统必须做一些额外的工作才能将名称解析为地址。

出于几个原因，通常值得这样做。首先，名字通常比点四分之一更容易让人记住。其次，名称提供了一定程度的指示性，使用户免受IP地址更改的影响。在本书撰写过程中，本书出版商的Web服务器Morgan Kaufmann将Internet地址从213.38.165.180更改为129.35.78.178。但是，因为我们将该Web服务器称为www.mkp.com（显然比213.38.165.180更容易记住），并且因为更改反映在将名称映射到地址的系统中（www.mkp.com现在解析为 新的Internet地址，而不是213.38.165.180），此更改对于使用该名称访问Web服务器的程序是透明的。

名称解析服务可以从各种来源访问信息。两个主要来源是域名系统（DNS）和本地配置数据库。DNS是一个分布式数据库，用于将域名（例如www.mkp.com）映射到Internet地址和其他信息；DNS协议允许连接到Internet的主机使用TCP或UDP从该数据库检索信息。 本地配置数据库通常是OS专用的机制，用于本地名称到Internet地址的映射。Microsoft Windows提供了一个主机文本文件，可以在其中对IP到域名的映射进行硬编码或覆盖。基于UNIX的系统通常具有一个名为/etc/hosts的文件，该文件可以执行相同的操作。

## 1.4 客户端和服务器

在我们的邮政和电话类比中，每一种通信都是由一方发起的，一方发送一封信或拨打电话，而另一方则通过发送回信或接听电话和交谈来回复发起方的联系。互联网通讯类似。术语客户端和服务器是指以下角色：客户端程序启动通信，而服务器程序被动地等待，然后响应与之联系的客户端。客户端和服务器共同组成应用程序。术语客户端和服务器描述了服务器使能够与之通信的任何客户端都具有特定功能（例如，数据库服务）的典型情况。
程序是充当客户端还是服务器，将决定其使用套接字API与同级通信的一般形式。（客户端是服务器的对等方，反之亦然。）此外，客户端与服务器之间的区别很重要，因为客户端首先需要知道服务器的地址和端口，反之则不然。使用套接字API，服务器在收到来自客户端的初始通信时，可以在必要时了解客户端的地址信息。这类似于电话呼叫-要被呼叫，一个人不需要知道呼叫者的电话号码。与电话通话一样，一旦建立连接，服务器和客户端之间的区别就会消失。

客户端如何找到服务器的IP地址和端口号？通常，客户端可以从通用资源定位器（URL）（例如http://www.mkp.com）中知道其所需的服务器名称，并使用名称解析服务来学习相应的Internet地址。
查找服务器的端口号是另一回事。原则上，服务器可以使用任何端口，但是客户端必须能够了解端口是什么。在Internet中，有一种约定为某些应用程序分配众所周知的端口号。 Internet分配号码授权机构（IANA）负责监督此分配。例如，端口号21已分配给文件传输协议。当您运行FTP客户端应用程序时，默认情况下它将尝试与该端口上的FTP服务器联系。Internet的编号机构维护所有已分配端口号的列表（请参阅www.iana.org/assignments/portnumbers）。

对于目录服务，还有许多标准，协议和建议，客户端可以通过这些目录从目录中查询服务器可用的服务和位置。当然，客户端必须知道用于联系目录服务服务器的地址和端口才能找到此信息！同样，通常将其定义和发布为目标客户的“知名”位置。

## 1.5 什么是套接字？

套接字是一种抽象，应用程序可以通过它来发送和接收数据，其方式与打开文件允许应用程序将数据读写到稳定存储中的方式大致相同。套接字允许应用程序“插入”网络，并与也插入同一网络的其他应用程序通信。由一台计算机上的应用程序写入套接字的信息可以由另一台计算机上的应用程序读取，反之亦然。

不同类型的套接字对应于不同的基础协议套件和套件中的协议堆栈。本书仅涉及TCP/IP协议套件。当今，TCP/IP中套接字的主要类型是流套接字和数据报套接字。流套接字将TCP用作端到端协议（在其下面带有IP），从而提供可靠的字节流服务。数据报套接字使用UDP（同样，端对端使用IP），从而提供了尽力而为的数据报服务，应用程序可以使用该数据报服务发送单个消息，最大长度约为65,500字节。其他协议套件也支持流和数据报套接字，但是本书仅涉及TCP流套接字和UDP数据报套接字。TCP/IP套接字由Internet地址，端到端协议（TCP或UDP）和端口号唯一标识。在继续过程中，您将遇到几种将套接字绑定到地址的方法。

图1.2描述了单个主机内的应用程序，套接字抽象，协议和端口号之间的逻辑关系。注意，一个套接字抽象可以被多个应用程序引用。每个具有特定套接字引用（称为描述符）的程序都可以通过该套接字进行通信。前面我们说过，端口可以标识主机上的应用程序。实际上，端口标识主机上的套接字。图1.2显示了主机上的多个程序可以访问同一套接字。实际上，访问相同套接字的单独程序通常属于同一应用程序（例如，Web服务器程序的多个副本），尽管原则上它们可以属于不同的应用程序。



图1.2 套接字，协议和端口

